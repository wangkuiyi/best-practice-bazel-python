# Using Bazel to Build a Python Project

## Bazel Accelerates CI

Typically, we don't add Bazel build rules to Python projects. However, when we do, Bazel can significantly accelerate CI by:

1. **Testing only affected targets** based on file changes
2. **Caching test results** and reusing them when code hasn't changed
3. **Remote caching** to share build/test results across CI runs

### 1. Automatic Dependency Analysis

Bazel automatically determines which tests need to run based on what changed:

```bash
# Test only targets affected by changes since last commit
bazel test --test_tag_filters=-manual //... --build_tests_only

# Test only targets affected by changes compared to main branch
git diff --name-only main... | xargs bazel query --universe_scope=//... "rdeps(//..., set({}))" | xargs bazel test
```

### 2. Test Result Caching

```bash
# Bazel caches test results - unchanged tests won't re-run
bazel test //... --cache_test_results=yes  # (default is yes)
```

### 3. Remote Caching for CI

```python
# .bazelrc
build:ci --remote_cache=https://your-cache-server.com
build:ci --remote_upload_local_results=true
test:ci --test_output=errors  # Only show failed test output
```

### Example Python Project Structure

```python
# BUILD.bazel file for a Python module
py_library(
    name = "user_lib",
    srcs = ["user.py"],
    deps = ["//common:database"],
)

py_test(
    name = "user_test",
    srcs = ["user_test.py"],
    deps = [":user_lib"],
)
```

### CI Workflow Example (GitHub Actions)

```yaml
name: Test
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Need full history for comparison
      
      - name: Mount bazel cache
        uses: actions/cache@v3
        with:
          path: ~/.cache/bazel
          key: bazel-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            bazel-${{ runner.os }}-
      
      - name: Test only affected targets
        run: |
          # Get changed files
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
          
          # Find affected targets
          TARGETS=$(bazel query --keep_going \
            --universe_scope=//... \
            "rdeps(//..., set(${CHANGED_FILES}))")
          
          # Test only affected targets
          if [ ! -z "$TARGETS" ]; then
            bazel test $TARGETS --test_output=errors
          fi
```

### Advanced: Bazel + BuildBuddy/BuildFarm

For maximum CI speed, use a remote build execution service:

```bash
# .bazelrc
build:remote --remote_executor=grpcs://remote.buildbuddy.io
build:remote --remote_cache=grpcs://remote.buildbuddy.io
build:remote --remote_timeout=3600
build:remote --remote_default_exec_properties=OSFamily=linux
```

### Benefits You'll See

- **First run**: Full test suite runs
- **Subsequent runs**: Only changed code + dependencies tested
- **No changes**: Tests complete in seconds (just cache checks)
- **Remote cache**: Share results across developers and CI runs

## How

This project contains a simple Bazel project.

```
.
├── a.py  - a sample program
├── .bazelrc - configures Bazel's behavior
├── BUILD.bazel  - where the build rules go
├── MODULE.bazel - marks project root and deps from requirements_lock.txt
├── MODULE.bazel.lock  - automatically generated but should be Git checked
├── requirements_lock.txt  - generated by pip-compile form requirements.txt
└── requirements.txt - list pip dependencies
```

### Describe Dependencies

The file `requirements.txt` usually contains loose version constraints. We run the following commands to generate `requirements_lock.txt`, which lists all dependencies with exact versions.

```bash
pip install pip-tools
pip-compile --allow-unsafe --no-strip-extras -o requirements_lock.txt requirements.txt
```

Please be aware of the options `--allow-unsafe` and `--no-strip-extras`.  We need them; otherwise, `pip-compile` will ignore "unsafe" packages like setuptools, which is required by TensorFlow, a dependency of AXLearn.

### Install Dependencies

The file `MODULE.bazel` contains the following lines to install dependencies from `requirements_lock.txt`.

```bazel
pip = use_extension("@rules_python//python/extensions:pip.bzl", "pip")
pip.parse(hub_name = "pip", python_version = "3.10", requirements_lock = "//:requirements_lock.txt")
use_repo(pip, "pip")
```

### Check Dependencies

Run the following command to check what is installed in the Bazel build sandbox.

```bash
bazel query '@pip//...'
```

### Build and Run

The following command queries targets in the current project (not including pip-installed dependencies):

```bash
bazel query //...
```

The following command builds and runs all targets:

```bash
bazel run //...
```
and tests

```bash
bazel test --cache_test_results=no --test_output=all //...
```

### Output Directories

I add the following line to the file `.bazelrc` to make Bazel generate files in the directory `.bazel-build/`.

```bazel
build --symlink_prefix=.bazel-build/
```

### Cleanup

The following command cleans up the building environment:

```bash
bazel clean --expunge
```
